#!/usr/bin/bash

BUCKET_NAME=${BUCKET_NAME:-trade-tariff-reporting}

function 6_weeks_ago() {
  date -d "6 weeks ago" +"%Y/%m/%d"
}

function year() {
  echo "$1" | cut -d'/' -f1
}

function month() {
  echo "$1" | cut -d'/' -f2
}

function day() {
  echo "$1" | cut -d'/' -f3
}

function fetch_candidate_keys() {
  year=$(year "$1")
  month=$(month "$1")
  day=$(day "$1")

  aws s3api list-objects \
    --bucket "$BUCKET_NAME" \
    --query "Contents[?contains(Key, 'electronic_tariff_file')].Key" \
    | grep -E 'uk/reporting/[0-9]{4}/[0-9]{2}/[0-9]{2}/electronic_tariff_file/' \
    | awk -F'/' "(\$3 <= $year && \$4 <= $month && \$5 < $day)"
}

function transform_candidate_keys() {
  while IFS= read -r line; do
    echo "$line"
  done \
    | tr -d '"' \
    | tr ',' '\n' \
    | sed 's/^ //' \
    | jq -nR '[inputs | { "Key": . }] | map(select(.Key != "")) | map(.Key |= sub("^\\s+"; ""))'
}


function rotate() {
  older_than=$(6_weeks_ago)
  keys_to_delete=$(fetch_candidate_keys "$older_than" | transform_candidate_keys)

  if [[ -z "$keys_to_delete" ]]; then
    echo "No files to delete"
    exit 0
  fi

  echo "Deleting files older than $older_than"
  echo "$keys_to_delete"

  delete_list=$(echo "$keys_to_delete" | jq -c '{Objects: .}')

  aws s3api delete-objects \
    --bucket "$BUCKET_NAME" \
    --delete "$delete_list"
}

rotate
